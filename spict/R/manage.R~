# Stochastic surplus Production model in Continuous-Time (SPiCT)
#    Copyright (C) 2015  Martin Waever Pedersen, mawp@dtu.dk or wpsgodd@gmail.com
#
#    This program is free software: you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation, either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program.  If not, see <http://www.gnu.org/licenses/>.



#' @name manage
#' @title Calculate predictions under different management scenarios
#' @param datin Data list.
#' @param pl Parameter list.
#' @param inp List of input variables as output by check.inp.
#' @param phase Estimation phase, integer.
#' @return List to be used as data input to TMB.
#' @import TMB
manage <- function(repin, scenarios='all', dbg=dbg){

    inpin <- list()
    inpin$timeC <- repin$inp$timeC
    inpin$obsC <- repin$inp$obsC
    inpin$timeI <- repin$inp$timeI
    inpin$obsI <- repin$inp$obsI
    inpin$timepredc <- repin$inp$timepredc
    inpin$timepredi <- repin$inp$timepredi

    repman <- list() # Output list
    
    # 1. Specify the catch, which will be taken each year in the prediction period
    # Default catch: MSY
    catch <- get.par('MSY', repin)[2]
    inp[[1]] <- inp
    timecatch <- annual(repin$inp$time[repin$inp$indpred], numeric(length(repin$inp$indpred)))$anntime
    ncatch <- length(timecatch)
    obscatch <- rep(catch, ncatch)
    inp[[1]]$timeC <- c(inp4$timeC, timecatch)
    inp[[1]]$obsC <- c(inp4$obsC, obscatch)
    inp[[1]] <- check.inp(inp[[1]])
    pl <- repin$obj$env$parList(repin$opt$par)
    datin <- make.datin(inp[[1]], dbg=dbg)
    # Create TMB object
    obj <- make.obj(datin, pl, inp[[1]], phase=1)
    obj$fn(repin$opt$par)
    #rep3 <- sdreport(obj3, ignore.parm.uncertainty=TRUE)
    repman[[1]] <- sdreport(obj)
    repman[[1]]$inp <- inp[[1]]

    return(repman)
}
